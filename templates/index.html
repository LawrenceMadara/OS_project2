<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nutritional Insights</title>

    <!-- Tailwind -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.0.0/dist/tailwind.min.css" rel="stylesheet">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
</head>

<body class="bg-gray-100 font-sans">

<header class="bg-blue-600 p-4 text-white">
    <h1 class="text-3xl font-semibold text-center">Nutritional Insights Dashboard</h1>
</header>

<main class="container mx-auto p-6">

    <!-- Search Bar + Filters -->
    <section class="mb-10">
        <h2 class="text-2xl font-semibold mb-4 text-gray-800">Search for Food Recipe</h2>

        <div class="flex flex-wrap gap-4 mb-4">
            <input id="searchInput"
                   class="p-2 border rounded w-full sm:w-auto"
                   placeholder="Type a food (example: chicken, oats, salad)">
        </div>

        <!-- Recipe Result -->
        <div id="recipeResult" class="bg-white p-4 shadow rounded hidden">
            <h3 class="text-xl font-semibold mb-2">Recipe Result</h3>
            <div id="recipeContent" class="text-gray-800"></div>
        </div>
    </section>


    <!-- Existing Charts -->
    <section class="mb-10">
        <h2 class="text-2xl font-semibold mb-4 text-gray-800">Explore Nutritional Insights</h2>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">

            <div class="bg-white p-4 shadow-lg rounded-lg flex flex-col items-center">
                <h3 class="font-semibold mb-2">Protein Bar Chart</h3>
                <canvas id="proteinChart" style="max-height: 200px;"></canvas>
            </div>

            <div class="bg-white p-4 shadow-lg rounded-lg flex flex-col items-center">
                <h3 class="font-semibold mb-2">Carbs Bar Chart</h3>
                <canvas id="carbsChart" style="max-height: 200px;"></canvas>
            </div>

            <div class="bg-white p-4 shadow-lg rounded-lg flex flex-col items-center">
                <h3 class="font-semibold mb-2">Fat Bar Chart</h3>
                <canvas id="fatChart" style="max-height: 200px;"></canvas>
            </div>

            <div class="bg-white p-4 shadow-lg rounded-lg flex flex-col items-center">
                <h3 class="font-semibold mb-2">Macronutrient Overview</h3>
                <canvas id="heatmapChart" style="max-height: 200px;"></canvas>
            </div>
        </div>
    </section>

    <section class="mb-10">
        <h2 class="text-2xl font-semibold mb-4 text-gray-800">Top Protein Recipes</h2>
        <div class="bg-white p-6 shadow-lg rounded-lg flex flex-col items-center">
            <canvas id="topProteinChart" style="max-height: 400px;"></canvas>
        </div>
    </section>

</main>

<footer class="bg-blue-600 p-4 text-white text-center mt-10">
    <p>&copy; 2025 Nutritional Insights</p>
</footer>


<!-- JS -->
<script>
    // ---------------------- SEARCH RECIPE ----------------------
    document.getElementById("searchInput").addEventListener("keypress", async function (e) {
        if (e.key === "Enter") {
            e.preventDefault();

            const query = this.value.trim();
            const resultDiv = document.getElementById("recipeResult");
            const contentDiv = document.getElementById("recipeContent");

            if (!query) {
                resultDiv.classList.remove("hidden");
                contentDiv.innerHTML = "<p>Please type a food item.</p>";
                return;
            }

            const res = await fetch(`/api/recipe?q=${encodeURIComponent(query)}`);
            const data = await res.json();

            resultDiv.classList.remove("hidden");

            if (!data.found) {
                contentDiv.innerHTML = `<p class='text-red-600'>${data.message}</p>`;
                return;
            }

            const r = data.recipe;

            contentDiv.innerHTML = `
                <h4 class="text-lg font-bold mb-2">${r.title}</h4>

                <h5 class="font-semibold">Ingredients:</h5>
                <ul class="list-disc ml-6 mb-3">
                    ${r.ingredients.map(i => `<li>${i}</li>`).join("")}
                </ul>

                <h5 class="font-semibold">Steps:</h5>
                <ol class="list-decimal ml-6">
                    ${r.steps.map(s => `<li>${s}</li>`).join("")}
                </ol>
            `;
        }
    });


    // ---------------------- EXISTING CHARTS ----------------------
    let charts = { protein:null, carbs:null, fat:null, heatmap:null, topProtein:null };

    const dietColors = {
        'Vegan':'rgba(34,139,34,0.7)',
        'Keto':'rgba(255,99,132,0.7)',
        'Paleo':'rgba(255,159,64,0.7)',
        'Vegetarian':'rgba(75,192,192,0.7)',
        'Dash':'rgba(153,102,255,0.7)',
        'Mediterranean':'rgba(54,162,235,0.7)'
    };

    const commonOptions = {responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}};

    async function initCharts() {
        const avgMacros = await fetch('/api/avg_macros').then(r => r.json());
        const topProtein = await fetch('/api/top_protein').then(r => r.json());

        createProteinChart(avgMacros);
        createCarbsChart(avgMacros);
        createFatChart(avgMacros);
        createHeatmapChart(avgMacros);
        createTopProteinChart(topProtein);
    }

    function createProteinChart(data) {
        const ctx = document.getElementById('proteinChart');
        if (charts.protein) charts.protein.destroy();
        charts.protein = new Chart(ctx, {
            type:'bar',
            data:{
                labels:data.map(d=>d.Diet_type),
                datasets:[{data:data.map(d=>d['Protein(g)']), backgroundColor:'rgba(34,139,34,0.7)'}]
            },
            options:commonOptions
        });
    }

    function createCarbsChart(data) {
        const ctx=document.getElementById('carbsChart');
        if(charts.carbs) charts.carbs.destroy();
        charts.carbs=new Chart(ctx,{
            type:'bar',
            data:{labels:data.map(d=>d.Diet_type),datasets:[{data:data.map(d=>d['Carbs(g)']),backgroundColor:'rgba(255,159,64,0.7)'}]},
            options:commonOptions
        });
    }

    function createFatChart(data) {
        const ctx=document.getElementById('fatChart');
        if(charts.fat) charts.fat.destroy();
        charts.fat=new Chart(ctx,{
            type:'bar',
            data:{labels:data.map(d=>d.Diet_type),datasets:[{data:data.map(d=>d['Fat(g)']),backgroundColor:'rgba(153,102,255,0.7)'}]},
            options:commonOptions
        });
    }

    function createHeatmapChart(data){
        const ctx=document.getElementById('heatmapChart');
        if(charts.heatmap) charts.heatmap.destroy();
        charts.heatmap=new Chart(ctx,{
            type:'bar',
            data:{labels:data.map(d=>d.Diet_type),
            datasets:[
                {label:'Protein',data:data.map(d=>d['Protein(g)']),backgroundColor:'rgba(34,139,34,0.7)'},
                {label:'Carbs',data:data.map(d=>d['Carbs(g)']),backgroundColor:'rgba(255,159,64,0.7)'},
                {label:'Fat',data:data.map(d=>d['Fat(g)']),backgroundColor:'rgba(255,99,132,0.7)'}
            ]},
            options:{responsive:true, plugins:{legend:{display:true}}}
        });
    }

    function createTopProteinChart(data){
        const ctx=document.getElementById('topProteinChart');
        if(charts.topProtein) charts.topProtein.destroy();

        const groups={};
        data.forEach(item=>{
            if(!groups[item.Diet_type]) groups[item.Diet_type]=[];
            groups[item.Diet_type].push(item);
        });

        const datasets=Object.keys(groups).map(diet=>({
            label:diet,
            data:groups[diet].map((item,i)=>({x:i+1,y:item['Protein(g)'],recipe:item.Recipe_name})),
            backgroundColor:dietColors[diet]||'rgba(54,162,235,0.7)'
        }));

        charts.topProtein=new Chart(ctx,{
            type:'scatter',
            data:{datasets},
            options:{plugins:{legend:{display:true}}}
        });
    }

    window.addEventListener('load', initCharts);
</script>

</body>
</html>
